# will circle ci pick this up now?
version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@6.7.0

jobs:
  build-ci:
    machine:
      image: ubuntu-2004:202104-01
    steps:
      - add_ssh_keys:
          fingerprints:
            - 3d:e6:7f:cd:d1:2b:35:a5:71:da:87:12:c2:0b:0b:44
            - ef:ec:5d:99:f7:ec:d8:35:ff:f6:2b:8b:23:a1:fa:f4
      - run:
          command: ssh-add -D
      - run:
          command: ssh-add ~/.ssh/id_rsa_3de67fcdd12b35a571da8712c20b0b44
      - run:
          name: Clone Bichard7 Next
          command: git clone --depth 1 git@github.com:ministryofjustice/bichard7-next.git ~/bichard7-next

      - run:
          command: ssh-add -D
      - run:
          command: ssh-add ~/.ssh/id_rsa_efec5d99f7ecd835fff62b8b23a1faf4
      - run:
          name: Clone Bichard7 Next Audit Logging
          command: git clone --depth 1 git@github.com:ministryofjustice/bichard7-next-audit-logging.git ~/bichard7-next-audit-logging

      - run:
          name: Build Bichard7 Next
          command: |
            cd ~/bichard7-next
            make build-ci
      - persist_to_workspace:
          root: ~/
          paths: bichard7-next
      - run:
          name: Build Bichard7 Next Audit Logging
          command: |
            cd ~/bichard7-next-audit-logging
            nvm install
            bash ./scripts/install-all.sh
            bash ./scripts/build-all.sh
      - persist_to_workspace:
          root: ~/
          paths: bichard7-next-audit-logging

  test-next:
    machine:
      image: ubuntu-2004:202104-01
      docker_layer_caching: true
    resource_class: large
    environment:
      STACK_TYPE: next
      MESSAGE_ENTRY_POINT: s3
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run:
          name: Clear out the networks before we start our Docker services
          command: docker network prune -f
      - run:
          name: Fetch the user-service image
          command: |
            cd ~/bichard7-next
            bash scripts/fetch_user_service_docker.sh
      - run:
          name: Run docker services (except BeanConnect)
          command: |
            cd ~/bichard7-next
            make run-all-no-bc -j 4
      - run:
          name: Fetch the PNC Emulator image
          command: |
            cd ~/bichard7-next
            bash scripts/fetch_pncemulator_docker.sh
      - run:
          name: Fetch the BeanConnect image
          command: |
            cd ~/bichard7-next
            bash scripts/fetch_beanconnect_docker.sh
      - run:
          name: Run BeanConnect and PNC Emulator docker services
          command: |
            cd ~/bichard7-next
            make run-beanconnect
      - run:
          name: Wait for Bichard
          command: |
            cd ~/bichard7-next
            bash ./scripts/wait_for_bichard.sh

      - run:
          name: Run Audit Logging
          command: bash ./.circleci/scripts/run-audit-logging.sh

      - run:
          name: Build E2E tests
          command: make build
      - run:
          name: Run E2E tests
          command: |
            cd ~/bichard7-next
            WORKSPACE=local-next make e2e-tests

  test-baseline:
    machine:
      image: ubuntu-2004:202104-01
      docker_layer_caching: true
    environment:
      STACK_TYPE: baseline
      MESSAGE_ENTRY_POINT: mq
    steps:
      - attach_workspace:
          at: ~/
      - run:
          command: docker network prune -f
          name: Clear out the networks before we start our Docker services
      - run:
          name: Run docker services (except BeanConnect)
          command: |
            cd ~/bichard7-next
            make run-all-baseline-no-bc -j 4
      - run:
          name: Fetch the PNC Emulator image
          command: |
            cd ~/bichard7-next
            bash scripts/fetch_pncemulator_docker.sh
      - run:
          name: Fetch the BeanConnect image
          command: |
            cd ~/bichard7-next
            bash scripts/fetch_beanconnect_docker.sh
      - run:
          name: Run BeanConnect and PNC Emulator docker services
          command: |
            cd ~/bichard7-next
            make run-beanconnect
      - run:
          name: Wait for Bichard
          command: |
            cd ~/bichard7-next
            bash ./scripts/wait_for_bichard.sh
      - run:
          name: Wait for DB2
          command: |
            cd ~/bichard7-next
            ./scripts/db/wait_for_db.sh
      - checkout
      - run:
          name: Build E2E tests
          command: make build
      - run:
          name: Run E2E tests
          command: |
            cd ~/bichard7-next
            WORKSPACE=local-baseline make e2e-tests
workflows:
  version: 2

  deploy:
    jobs:
      - build-ci
      - test-next:
          requires:
            - build-ci
      - test-baseline:
          requires:
            - build-ci
